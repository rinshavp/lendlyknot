<!-- booking_list.html -->
<!DOCTYPE html>
<html>
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Booking</title>
     <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_green.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Additional custom styles can go here */
        /*  body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            padding-top: 100px;
        } */
        input[type="text"] {
            max-width: 300px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* Style for disabled dates */
        .flatpickr-calendar .flatpickr-day.flatpickr-disabled {
            background: #ffcccc; /* Light red background */
            color: #666; /* Darker text color to indicate it's disabled */
            cursor: not-allowed;
        }
    </style>
</head>
<body>
   
    <h3>Available Sizes for {{ product.product_name }}</h3><br>
    {% if available_sizes %}
        
        <div>
            <form id="bookingForm">
               
                <label for="productSize">Select an Size:</label>  
                <select id="productSize" name="productSize">
                    <option value=""></option>
                    {% for key,value in available_sizes.items %}
                       <option value="{{ key }}">{{ value }}</option>
                    {% endfor %}
                </select>
               
                {% else %}
                <p>No sizes available for this product.</p>
                <br>
            </form>
        </div>
    {% endif %}
 
    <!-- <input type="text" id="datePicker" placeholder="Select Date Range"> -->
    <div class="flatpickr">
        <input type="text" id="selectedDates" placeholder="Select Date.." data-input> <!-- input is mandatory -->
    
        <a class="input-button" title="toggle" data-toggle>
            <span class="material-icons">calendar_today</span>   
        </a>
        
        <a class="input-button" title="clear" data-clear>
            <span class="material-icons">close</span>
        </a>
    </div>
    <br>
    
    <label for="quantity">Quantity:</label>
    <input type="number" id="quantity" name="quantity" min="1" max="5" >

    <button type="button" onclick="bookingForm()">Book Now</button>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script> 
    <script>
        
         // Declare flatpickrInstance in a broader scope
        var flatpickrInstance;
        var formattedFromDate, formattedToDate;
        document.getElementById('productSize').addEventListener('change', function () {
            var selectedSize = this.value;
            
            if (selectedSize) {

                // Make an AJAX request to fetch start and end dates based on the selected size
                var product_id = "{{ product.id }}"
                
                fetch(`/get_dates/${product_id}/${selectedSize}/`)
                    .then(response => response.json())
                    .then(data => {
                            const bookedDates = data.fully_booked_dates; // Use the Django template tag to insert the JSON
                            console.log(bookedDates); 
                            flatpickr(".flatpickr", {
                                mode: "range",
                                minDate: "today",
                                dateFormat: "Y-m-d",
                                conjunction: " :: ",
                                disable: bookedDates, // Map to required format
                                wrap: true,
                                onClose: function (selectedDates, dateStr, instance) {
                                    var fromDate = selectedDates[0];
                                    var toDate = selectedDates[1];

                                    formattedFromDate = fromDate.getFullYear() + '-' + ('0' + (fromDate.getMonth() + 1)).slice(-2) + '-' + ('0' + fromDate.getDate()).slice(-2);
                                    formattedToDate = toDate.getFullYear() + '-' + ('0' + (toDate.getMonth() + 1)).slice(-2) + '-' + ('0' + toDate.getDate()).slice(-2);
                                    console.log(selectedDates);
                                     // Do something with the selected dates
                                } 
                            });
    
                    });
            } else {
    
                alert('no item');
            }
        });

        function bookingForm() {
            
            var selectedSize = document.getElementById('productSize').value;
            var fromDate = formattedFromDate
            var toDate = formattedToDate
            var quantity = document.getElementById('quantity').value;
            var product_id = "{{ product.id }}"
            var user_id = "{{ request.session.user_id }}"
            
            var formData = {
                'user': user_id,
                'product': product_id,
                'start_date': fromDate,
                'end_date': toDate,
                'quantity_rented': quantity,
                'booked_size': selectedSize
            };

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // Make an AJAX request to the server
            fetch('/product_booking/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken    // Add the CSRF token if using Django
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                // Handle the response from the server as needed
                console.log(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
    </script>
    
</body>
</html>
